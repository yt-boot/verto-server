# 业务设计总览（基于 verto.sql 对齐）——应用管理 / 项目管理 / 人员管理 / 绑定 Git 账号 / 积分管理

说明：本文档覆盖在 JeecgBoot 上新增或梳理的业务模块，重点聚焦数据库设计与接口设计逻辑，便于后续联调与扩展。模块包括：应用管理、项目管理、人员管理与组织、绑定 Git 账号、积分管理。

—

全局约定（通用）
- 数据库：MySQL 5.7+，InnoDB，utf8mb4_unicode_ci。
- 返回结构：统一使用 JeecgBoot Result<T>，分页统一 records/total。
- 软删：del_flag TINYINT(1) 默认 0；查询默认过滤 del_flag = 0。
- 多租户与组织：保留 tenant_id、sys_org_code 字段以支持租户与数据权限。
- 审计字段：create_time/create_by/update_time/update_by 按 JeecgBoot 统一规范。
- ID 规范：主键优先使用 UUID/雪花，跨模块引用统一使用字符串主键。

0、数据库 ER 图（基于 verto.sql）
- 下图基于当前数据库脚本 d:\github_workspace\verto-workspace\verto-server\db\verto.sql 生成的实体与关系，可用于整体把握模块间的关联。

```mermaid
erDiagram
    APP_MANAGE {
        varchar id
        varchar app_name
        text app_description
        varchar git_url
        varchar domain
        text managers
        longtext extra_info
        tinyint status
        varchar create_by
        datetime create_time
        varchar update_by
        datetime update_time
    }
    APP_GIT_REPO_INFO {
        varchar id
        varchar app_id
        varchar owner
        varchar repo_name
        varchar html_url
        varchar clone_url
        varchar ssh_url
        text description
        varchar visibility
        int stars
        int forks
        int open_issues
        varchar license
        text topics
        varchar default_branch
        int branch_count
        varchar last_commit_sha
        text last_commit_message
        varchar last_committer
        datetime last_commit_time
        datetime created_at
        datetime updated_at
        datetime last_synced_at
    }
    APP_PIPELINE_BINDING {
        varchar id
        varchar app_id
        varchar environment
        varchar job_name
        varchar job_url
        varchar status
        varchar create_by
        datetime create_time
        varchar update_by
        datetime update_time
    }
    PROJECT {
        varchar id
        varchar project_type
        varchar requirement_id
        varchar bug_id
        varchar title
        text description
        varchar related_app_id
        varchar related_app_name
        varchar developer_id
        varchar developer_name
        text design_links
        datetime start_time
        datetime test_time
        datetime online_time
        datetime release_time
        varchar status
        varchar git_branch
        text app_config
        varchar create_by
        datetime create_time
        varchar update_by
        datetime update_time
        varchar priority
    }
    OAUTH_USER {
        bigint id
        varchar platform
        varchar oauth_user_id
        varchar login
        varchar name
        varchar avatar_url
        varchar email
        datetime bound_at
        datetime created_at
        datetime updated_at
        bigint last_token_id
    }
    OAUTH_TOKEN {
        bigint id
        varchar platform
        varchar oauth_user_id
        varchar access_token
        varchar token_type
        varchar scope
        datetime created_at
        datetime expires_at
    }
    OAUTH_BINDING {
        bigint id
        varchar system_user_id
        varchar platform
        varchar oauth_user_id
        datetime created_at
        datetime updated_at
    }
    SYS_USER {
        varchar id
        string name
        string ...
    }

    APP_MANAGE ||--o{ APP_GIT_REPO_INFO : contains
    APP_MANAGE ||--o{ APP_PIPELINE_BINDING : binds
    APP_MANAGE ||--o{ PROJECT : related
    OAUTH_USER ||--o{ OAUTH_TOKEN : has
    OAUTH_USER ||--o{ OAUTH_BINDING : linkedBy
    SYS_USER ||--o{ OAUTH_BINDING : binds
```

补充：ER 图中文注释增强版（可在支持 Mermaid 的渲染器中查看）

```mermaid
erDiagram
    APP_MANAGE {
        varchar id_主键ID
        varchar app_name_应用名称
        text app_description_应用描述
        varchar git_url_Git仓库地址
        varchar domain_应用领域
        text managers_管理员列表(JSON)
        longtext extra_info_附加信息(JSON)
        tinyint status_状态(0禁用1启用)
        varchar create_by_创建人
        datetime create_time_创建时间
        varchar update_by_更新人
        datetime update_time_更新时间
    }
    APP_GIT_REPO_INFO {
        varchar id_主键ID
        varchar app_id_应用ID
        varchar owner_仓库所有者
        varchar repo_name_仓库名称
        varchar html_url_仓库页面
        varchar clone_url_HTTP克隆
        varchar ssh_url_SSH克隆
        text description_描述
        varchar visibility_可见性(public/private)
        int stars_Star数量
        int forks_Fork数量
        int open_issues_未关闭Issue数
        varchar license_许可证
        text topics_主题标签
        varchar default_branch_默认分支
        int branch_count_分支数量
        varchar last_commit_sha_最后提交SHA
        text last_commit_message_最后提交信息
        varchar last_committer_最后提交者
        datetime last_commit_time_最后提交时间
        datetime created_at_仓库创建时间
        datetime updated_at_仓库更新时间
        datetime last_synced_at_最近同步时间
    }
    APP_PIPELINE_BINDING {
        varchar id_主键ID
        varchar app_id_应用ID
        varchar environment_环境
        varchar job_name_任务名称
        varchar job_url_任务地址
        varchar status_状态
        varchar create_by_创建人
        datetime create_time_创建时间
        varchar update_by_更新人
        datetime update_time_更新时间
    }
    PROJECT {
        varchar id_主键ID
        varchar project_type_项目类型(requirement/bug)
        varchar requirement_id_需求ID
        varchar bug_id_缺陷ID
        varchar title_项目标题
        text description_项目描述
        varchar related_app_id_关联应用ID
        varchar related_app_name_关联应用名称
        varchar developer_id_开发者ID
        varchar developer_name_开发者姓名
        text design_links_设计链接(JSON)
        datetime start_time_开始时间
        datetime test_time_测试时间
        datetime online_time_上线时间
        datetime release_time_发布时间
        varchar status_状态
        varchar git_branch_Git分支
        text app_config_应用配置(JSON)
        varchar create_by_创建人
        datetime create_time_创建时间
        varchar update_by_更新人
        datetime update_time_更新时间
        varchar priority_优先级
    }
    OAUTH_USER {
        bigint id_主键ID
        varchar platform_平台(github/gitlab等)
        varchar oauth_user_id_第三方用户ID
        varchar login_第三方登录名
        varchar name_显示名称
        varchar avatar_url_头像地址
        varchar email_邮箱
        datetime bound_at_绑定时间
        datetime created_at_创建时间
        datetime updated_at_更新时间
        bigint last_token_id_最近令牌ID
    }
    OAUTH_TOKEN {
        bigint id_主键ID
        varchar platform_平台
        varchar oauth_user_id_第三方用户ID
        varchar access_token_访问令牌
        varchar token_type_令牌类型
        varchar scope_权限范围
        datetime created_at_创建时间
        datetime expires_at_过期时间
    }
    OAUTH_BINDING {
        bigint id_主键ID
        varchar system_user_id_系统用户ID
        varchar platform_平台
        varchar oauth_user_id_第三方用户ID
        datetime created_at_绑定时间
        datetime updated_at_更新时间
    }
    SYS_USER {
        varchar id_系统用户ID
        string name_姓名(示意)
        string ..._更多字段
    }

    APP_MANAGE ||--o{ APP_GIT_REPO_INFO : 包含
    APP_MANAGE ||--o{ APP_PIPELINE_BINDING : 绑定
    APP_MANAGE ||--o{ PROJECT : 关联
    OAUTH_USER ||--o{ OAUTH_TOKEN : 拥有
    OAUTH_USER ||--o{ OAUTH_BINDING : 绑定关系
    SYS_USER ||--o{ OAUTH_BINDING : 绑定
```

一、应用管理（与 verto.sql 对齐）
1) 设计目标
- 统一管理公司内应用（系统/服务/组件）；与 Git 仓库信息和流水线绑定联动；为项目提供上游应用信息。

2) 数据库设计（现有表）
- 表：app_manage（应用主表）
```
CREATE TABLE `app_manage` (
  `id` varchar(32) NOT NULL COMMENT '主键ID',
  `app_name` varchar(100) NOT NULL COMMENT '应用名称',
  `app_description` text COMMENT '应用描述',
  `git_url` varchar(500) DEFAULT NULL COMMENT 'Git仓库地址',
  `domain` varchar(50) DEFAULT NULL COMMENT '应用领域',
  `managers` text COMMENT '管理员列表(JSON数组)',
  `extra_info` longtext COMMENT '附加信息(JSON)',
  `status` tinyint(1) DEFAULT '1' COMMENT '状态',
  `create_by` varchar(50) DEFAULT NULL,
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP,
  `update_by` varchar(50) DEFAULT NULL,
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='应用管理表';
```
- 表：app_git_repo_info（应用 Git 仓库信息）
```
CREATE TABLE `app_git_repo_info` (
  `id` varchar(32) NOT NULL,
  `app_id` varchar(32) NOT NULL,
  `owner` varchar(100) NOT NULL,
  `repo_name` varchar(200) NOT NULL,
  `html_url` varchar(500) DEFAULT NULL,
  `clone_url` varchar(500) DEFAULT NULL,
  `ssh_url` varchar(500) DEFAULT NULL,
  `description` text,
  `visibility` varchar(20) DEFAULT NULL,
  `stars` int DEFAULT '0',
  `forks` int DEFAULT '0',
  `open_issues` int DEFAULT '0',
  `license` varchar(100) DEFAULT NULL,
  `topics` text,
  `default_branch` varchar(100) DEFAULT NULL,
  `branch_count` int DEFAULT '0',
  `last_commit_sha` varchar(100) DEFAULT NULL,
  `last_commit_message` text,
  `last_committer` varchar(100) DEFAULT NULL,
  `last_commit_time` datetime DEFAULT NULL,
  `created_at` datetime DEFAULT NULL,
  `updated_at` datetime DEFAULT NULL,
  `last_synced_at` datetime DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='应用Git仓库信息表';
```
- 表：app_pipeline_binding（应用流水线绑定）
```
CREATE TABLE `app_pipeline_binding` (
  `id` varchar(64) NOT NULL,
  `app_id` varchar(64) NOT NULL,
  `environment` varchar(32) NOT NULL,
  `job_name` varchar(128) NOT NULL,
  `job_url` varchar(256) DEFAULT NULL,
  `status` varchar(16) NOT NULL DEFAULT 'enabled',
  `create_by` varchar(64) DEFAULT NULL,
  `create_time` datetime DEFAULT NULL,
  `update_by` varchar(64) DEFAULT NULL,
  `update_time` datetime DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
```

3) 接口设计
- 前缀：/jeecgboot/app
- 接口：
  - POST /create：创建应用
  - POST /update：更新应用信息
  - POST /delete：逻辑删除
  - GET /detail?id=：查询应用详情
  - GET /list：分页查询（按 app_name/domain/status/创建人 等筛选）
  - GET /repo/info?appId=：查询 Git 仓库信息（来自 app_git_repo_info）
  - POST /pipeline/bind：绑定流水线（environment, job_name, job_url）
  - GET /pipeline/list?appId=：流水线绑定列表
  - GET /repo/branches?appId=：基于绑定的 Git 账号与 git_url 列出分支（需 OAuth）

4) 权限
- app:view、app:edit、app:pipeline:manage、app:repo:view。

二、项目管理（与 verto.sql 对齐）
1) 设计目标
- 统一管理项目；项目可关联上游应用（app_manage），记录开发者与状态流转。

2) 数据库设计（现有表）
- 表：project（项目主表）
```
CREATE TABLE `project` (
  `id` varchar(32) NOT NULL COMMENT '主键ID',
  `project_type` varchar(20) NOT NULL COMMENT '项目类型(requirement/bug)',
  `requirement_id` varchar(50) DEFAULT NULL,
  `bug_id` varchar(50) DEFAULT NULL,
  `title` varchar(200) NOT NULL COMMENT '项目标题',
  `description` text,
  `related_app_id` varchar(32) DEFAULT NULL COMMENT '关联应用ID',
  `related_app_name` varchar(100) DEFAULT NULL,
  `developer_id` varchar(32) DEFAULT NULL COMMENT '开发者ID',
  `developer_name` varchar(50) DEFAULT NULL,
  `design_links` text COMMENT '设计链接(JSON数组)',
  `start_time` datetime DEFAULT NULL,
  `test_time` datetime DEFAULT NULL,
  `online_time` datetime DEFAULT NULL,
  `release_time` datetime DEFAULT NULL,
  `status` varchar(20) DEFAULT 'planning',
  `git_branch` varchar(100) DEFAULT NULL,
  `app_config` text,
  `create_by` varchar(50) DEFAULT NULL,
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP,
  `update_by` varchar(50) DEFAULT NULL,
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `priority` varchar(16) DEFAULT 'low'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='项目管理表';
```

3) 接口设计
- 前缀：/jeecgboot/project
- 接口：
  - POST /create、/update、/delete、GET /detail、GET /list
  - POST /assignDeveloper：设置/变更开发者（developer_id/ developer_name）
  - GET /byApp?appId=：按关联应用过滤项目
  - GET /repo/branches?projectId=：列出项目关联分支（需 OAuth，根据 git_url 与 git_branch）
  - GET /status/statistics：状态统计（planning/developing/testing/released）

4) 权限
- project:view、project:edit、project:assign。

三、人员管理与组织（复用 JeecgBoot，新增规范）
1) 设计目标
- 复用 JeecgBoot 系统用户与部门；在业务层统一使用 staff_id 作为人员唯一 ID，对外与各模块关联。

2) 数据库设计
- 复用：sys_user、sys_depart、sys_user_depart 等标准表。
- 建议新增（可选）视图/表：verto_staff_profile（对 sys_user 进行轻量封装与扩展）
```
CREATE TABLE `verto_staff_profile` (
  `id` varchar(32) NOT NULL COMMENT '主键ID（与 sys_user.id 对齐或独立）',
  `user_id` varchar(32) NOT NULL COMMENT 'sys_user.id',
  `display_name` varchar(128) DEFAULT NULL COMMENT '展示名',
  `title` varchar(64) DEFAULT NULL COMMENT '职务',
  `skills` varchar(256) DEFAULT NULL COMMENT '技能标签，逗号分隔',
  `phone` varchar(32) DEFAULT NULL,
  `email` varchar(128) DEFAULT NULL,
  `tenant_id` varchar(32) DEFAULT NULL,
  `sys_org_code` varchar(64) DEFAULT NULL,
  `create_time` datetime NOT NULL,
  `create_by` varchar(50) DEFAULT NULL,
  `update_time` datetime DEFAULT NULL,
  `update_by` varchar(50) DEFAULT NULL,
  `del_flag` tinyint(1) NOT NULL DEFAULT 0,
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='人员扩展档案';
```

3) 接口设计
- 前缀：/jeecgboot/staff
- 接口：
  - GET /list：分页人员列表（关键词、部门筛选）
  - GET /detail?id=：人员详情（包含 sys_user + profile + depart）
  - POST /profile/update：更新扩展档案（字段白名单）
  - GET /org/tree：组织树（复用系统组织接口或封装）

4) 权限与数据权限
- staff:view、staff:edit；结合 sys_org_code 进行数据权限过滤。

四、绑定 Git 账号（OAuth Binding）（与 verto.sql 对齐）
1) 设计目标
- 支持绑定外部 Git 平台（GitHub/GitLab/Gitee 等），用于拉取仓库、分支、提交记录等；与应用/项目模块联动。

2) 数据库设计（现有表）
- 表：oauth_user（第三方 OAuth 用户）
```
CREATE TABLE `oauth_user` (
  `id` bigint NOT NULL,
  `platform` varchar(32) NOT NULL,
  `oauth_user_id` varchar(128) NOT NULL,
  `login` varchar(128) NOT NULL,
  `name` varchar(256) DEFAULT NULL,
  `avatar_url` varchar(512) DEFAULT NULL,
  `email` varchar(256) DEFAULT NULL,
  `bound_at` datetime DEFAULT NULL,
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `last_token_id` bigint DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='第三方OAuth用户绑定表';
```
- 表：oauth_token（访问令牌）
```
CREATE TABLE `oauth_token` (
  `id` bigint NOT NULL,
  `platform` varchar(32) NOT NULL,
  `oauth_user_id` varchar(128) NOT NULL,
  `access_token` varchar(1024) NOT NULL,
  `token_type` varchar(64) DEFAULT 'Bearer',
  `scope` varchar(1024) DEFAULT NULL,
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `expires_at` datetime DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='第三方OAuth访问令牌表';
```
- 表：oauth_binding（系统用户与第三方绑定关系）
```
CREATE TABLE `oauth_binding` (
  `id` bigint NOT NULL,
  `system_user_id` varchar(64) NOT NULL,
  `platform` varchar(32) NOT NULL,
  `oauth_user_id` varchar(128) NOT NULL,
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='系统用户与第三方OAuth用户绑定关系表';
```
说明：以上三表通过 platform + oauth_user_id 逻辑关联；oauth_user.last_token_id 可指向最近一次令牌。

3) 接口设计
- 前缀：/jeecgboot/oauth
- 接口：
  - POST /bind：绑定（参数：platform, code/state 或 token；后端交换令牌并落库到 oauth_user/oauth_token，并在 oauth_binding 记录关系）
  - POST /unbind：解绑（根据 platform 清理绑定）
  - GET /bindings：当前用户绑定列表（来源 oauth_binding + oauth_user）
  - GET /providers：支持的 provider 列表与授权地址
  - GET /verify?platform=：校验令牌有效性

4) 安全与合规
- 令牌安全（密文存储、最小暴露范围）；审计 bind/unbind/verify 操作。

—

五、积分管理（新增）数据库与接口设计说明
一、业务概述（新增）
- 新增“积分管理”功能，用于记录人员每一次积分加/减的流水，支持查询与筛选，并提供“手动调整”入口。
- 不在库中冗余总分；总分通过积分流水的 delta 求和得到，更易维护与审计。

二、数据库设计（新增）
1) 新增表：staff_points_log（人员积分流水）
- 设计目标：满足按人员、时间、事件类型、来源类型等条件的查询；记录每一次调整的原因与来源，支持审计。
- 字段（建议 MySQL 5.7，InnoDB，utf8mb4）：
  - id：主键（varchar(32)），使用雪花/UUID，非空
  - staff_id：人员 ID（varchar(50)），与人员表主键一致，非空
  - delta：积分变动（int），支持负数，非 0
  - event_type：事件类型（varchar(32)），枚举值（如 MANUAL_ADJUST, OTHER），非空
  - source_type：来源类型（varchar(32)），枚举值（APP, PROJECT, COMPONENT, OTHER），非空
  - source_id：来源业务主键（varchar(64)），可空
  - source_name：来源名称（varchar(128)），用于展示，可空
  - remark：备注（text），可空
  - create_time：创建时间（datetime），非空
  - create_by：操作人（varchar(50)），可空
  - tenant_id：租户 ID（varchar(32)），可选，视项目租户策略而定
  - sys_org_code：部门/组织编码（varchar(64)），可选，便于数据权限
  - update_time：更新时间（datetime），可选
  - update_by：更新人（varchar(50)），可选
  - del_flag：逻辑删除（tinyint(1)，默认 0），与 JeecgBoot 规范保持一致

2) 建表 SQL（DDL 示例）
```
CREATE TABLE `staff_points_log` (
  `id` varchar(32) NOT NULL COMMENT '主键ID',
  `staff_id` varchar(50) NOT NULL COMMENT '人员ID',
  `delta` int NOT NULL COMMENT '积分变动（支持负数，非0）',
  `event_type` varchar(32) NOT NULL COMMENT '事件类型',
  `source_type` varchar(32) NOT NULL COMMENT '来源类型',
  `source_id` varchar(64) DEFAULT NULL COMMENT '来源业务主键',
  `source_name` varchar(128) DEFAULT NULL COMMENT '来源名称',
  `remark` text COMMENT '备注',
  `create_time` datetime NOT NULL COMMENT '创建时间',
  `create_by` varchar(50) DEFAULT NULL COMMENT '创建人',
  `update_time` datetime DEFAULT NULL COMMENT '更新时间',
  `update_by` varchar(50) DEFAULT NULL COMMENT '更新人',
  `tenant_id` varchar(32) DEFAULT NULL COMMENT '租户ID',
  `sys_org_code` varchar(64) DEFAULT NULL COMMENT '组织编码',
  `del_flag` tinyint(1) NOT NULL DEFAULT 0 COMMENT '删除标记',
  PRIMARY KEY (`id`),
  KEY `idx_staff_id` (`staff_id`),
  KEY `idx_create_time` (`create_time`),
  KEY `idx_event_type` (`event_type`),
  KEY `idx_source_type` (`source_type`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='人员积分流水';
```

3) 索引与约束
- 基础索引：staff_id、create_time、event_type、source_type；常用筛选条件均有索引以提升查询性能。
- 组合索引（可选）：可根据实际查询热点增加如 (staff_id, create_time) 的复合索引。
- 约束与校验：delta ≠ 0；event_type/source_type 合法枚举；staff_id 合法性由业务层校验。

4) 总分计算逻辑（不冗余）
- 总分 = SUM(delta) WHERE staff_id = ? AND del_flag = 0。
  - 示例：SELECT IFNULL(SUM(delta), 0) AS total_points FROM staff_points_log WHERE staff_id = ? AND del_flag = 0;
- 可在 Service 层封装 getSummary(staffId) 方法，便于统一调用。

5) 事务与审计（手动调整）
- 手动调整属于写操作：插入一条流水记录。
- 推荐在同一事务中完成：参数校验 -> 枚举校验 -> 插入流水 -> 记录 create_by。
- 需要审计时，可接入操作日志模块记录请求体与结果。

—

三、接口设计（新增）
1) 统一前缀与返回规范
- 接口前缀：/jeecgboot/staff/points
- 返回使用 JeecgBoot 的统一 Result<T> 格式（示例）：
  - 成功：{ "success": true, "message": "", "code": 200, "result": { ... }, "timestamp": 1710000000000 }
  - 分页：{ "success": true, "code": 200, "result": { "records": [...], "total": 123, ... } }

2) 接口列表与逻辑
- GET /summary
  - 描述：获取某人员的积分总分
  - 参数：staffId（必填）
  - 返回：{ totalPoints: number }
  - 逻辑：sum(delta) 按 staff_id 聚合；只统计 del_flag = 0 的记录。

- GET /logs
  - 描述：获取某人员的积分流水（分页）
  - 参数：
    - staffId：人员 ID（必填）
    - pageNo：页码，默认 1
    - pageSize：每页数量，默认 10
    - eventType：事件类型（可选）
    - sourceType：来源类型（可选）
    - keyword：关键字（可选，匹配 source_name / event_type / remark）
    - startTime、endTime：时间区间（可选，闭区间）
  - 返回：分页结构 { records: PointsLog[], total: number }
  - 过滤与排序：
    - WHERE staff_id = :staffId AND del_flag = 0
    - event_type/source_type 精确匹配（若传入）
    - keyword 模糊匹配 source_name、event_type、remark（任一命中）
    - create_time BETWEEN :startTime AND :endTime（若传入）
    - ORDER BY create_time DESC

- GET /logs/all
  - 描述：获取全员的积分流水（分页）
  - 参数：与 /logs 相同（去除 staffId），支持同样的过滤与排序逻辑。
  - 返回：分页结构 { records: PointsLog[], total: number }

- POST /adjust
  - 描述：为指定人员新增一条“手动调整”的积分流水（支持正负数）
  - 请求体：
    - staffId：必填
    - delta：必填，int，≠ 0，支持负数
    - remark：可选，最长 500（可在 Service 层校验）
    - sourceType：可选（默认 OTHER），枚举（APP/PROJECT/COMPONENT/OTHER）
    - eventType：可选（默认 MANUAL_ADJUST），枚举
    - sourceId：可选
    - sourceName：可选（默认“手动调整”）
  - 返回：{ success: true }
  - 逻辑与事务：
    - 参数合法性校验（staffId 存在性、delta ≠ 0、枚举校验等）
    - 插入一条流水记录（create_by 记录操作人）
    - 成功后返回统一 Result

3) 权限控制（新增）
- staff:points:view：允许查询日志（GET /summary、GET /logs、GET /logs/all）
- staff:points:adjust：允许执行调整（POST /adjust）
- 建议在 Controller 上通过 @RequiresPermissions 精细化控制。

4) 错误处理与返回约定
- 常见错误：
  - 400：参数校验失败（如 delta = 0、枚举不合法、staffId 缺失）
  - 404：人员不存在（可选）
  - 500：服务端异常
- 返回 message 友好提示；尽量复用 JeecgBoot 的统一异常处理。

—

四、与 JeecgBoot 集成（新增）
1) 包结构建议（jeecg-module-verto）
- controller：com.company.verto.points.controller
- service：com.company.verto.points.service
- service.impl：com.company.verto.points.service.impl
- mapper：com.company.verto.points.mapper
- entity：com.company.verto.points.entity
- enum：com.company.verto.points.enums（EventType、SourceType）

2) MyBatis-Plus 与返回结构
- Mapper 使用 MyBatis-Plus 分页插件，统一返回 IPage；Controller 层封装为 Result。
- 前端适配支持 records/total 结构；与 JeecgBoot 的 Result 兼容。

3) 代码生成器（新增部分）
- 可在代码生成器中配置 staff_points_log 的字段、字典（event_type、source_type），生成基础 CRUD 代码后按上文调整业务逻辑与权限。

—

五、扩展与兼容（新增）
- 多租户：tenant_id 字段；结合项目租户策略过滤数据。
- 组织维度：sys_org_code 字段；配合数据权限使用。
- 字典：为 event_type、source_type 配置字典项以便前端下拉选择与国际化。
- 性能优化：
  - 索引优化与分页（limit/offset）
  - keyword 模糊搜索可限制范围（仅 source_name/remark），避免扫描过大字段集
  - 如需高频展示总分，可考虑增加缓存或异步预聚合（非本次新增范围）

—

补充：积分规则与事件触发（新增）
1) 新增库表（已提供迁移脚本 db/migrations/patch_2025-11-04_staff_points.sql）
- staff_points_rule：配置事件（event_code）与来源（source_type/match_source_id）映射到积分变动（delta），支持 limit_per_day（每日上限）、first_time_only（仅首次）、condition_expr（JSON条件）、enabled（启用）及有效期。
- staff_points_balance：缓存个人总积分，减少高频聚合开销；在写入流水后增量更新。
- staff_points_dedup：事件幂等防重，建议使用 dedup_key = staffId + eventCode + sourceId + 日期（或业务流水号）。

2) 事件驱动实现建议（与后台操作自动联动）
- 事务边界：业务操作成功提交后发布事件（TransactionPhase.AFTER_COMMIT），避免业务失败却加分。
- 事件载荷：staffId、eventCode、sourceType、sourceId、sourceName、context（可选）
- 规则匹配：查询启用中的规则，按 event_code/source_type/match_source_id/condition_expr 过滤；校验 limit_per_day 与 first_time_only。
- 幂等检查：基于 staff_points_dedup 去重；重复则跳过。
- 落库与汇总：写入 staff_points_log（事实台账），并同步更新 staff_points_balance（增量）。
- 审计与补偿：失败重试、死信队列、人工修复工具（如重新触发某事件或回滚某流水）。

3) 示例事件编码（建议字典）
- APP_CREATE、APP_PIPELINE_BIND、APP_PIPELINE_SUCCESS
- PROJECT_CREATE、PROJECT_ASSIGN、PROJECT_RELEASE
- COMPONENT_PUBLISH、COMPONENT_UPDATE
- OTHER_MANUAL_ADJUST（手动调整）

4) 示例伪代码（Spring）
```
@Transactional
public void createProject(...) {
    // 1. 业务处理...
    // 2. 事务成功后发布事件
    applicationEventPublisher.publishEvent(new PointsEvent(
        staffId, "PROJECT_CREATE", "PROJECT", projectId, projectName, ctx));
}

@TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
public void handlePoints(PointsEvent evt) {
    // 幂等检查 + 规则匹配 + 限流 + 写入 staff_points_log + 更新 staff_points_balance
}
```

5) ER 子图（积分相关）
```mermaid
erDiagram
    STAFF_POINTS_LOG {
        varchar id_主键ID
        varchar staff_id_员工ID
        varchar event_type_事件类型
        varchar source_type_来源类型(APP/PROJECT/COMPONENT/OTHER)
        varchar source_id_来源ID
        varchar source_name_来源名称
        int delta_积分变动
        text remark_备注
        datetime create_time_创建时间
    }
    STAFF_POINTS_RULE {
        varchar id_主键ID
        varchar event_code_事件编码
        varchar source_type_来源类型
        varchar match_source_id_匹配来源ID
        int delta_积分变动
        int limit_per_day_每日上限
        tinyint first_time_only_仅首次有效
        json condition_expr_条件表达式
        tinyint enabled_是否启用
        datetime effective_time_生效时间
        datetime expire_time_失效时间
        text remark_备注
        datetime create_time_创建时间
        datetime update_time_更新时间
    }
    STAFF_POINTS_BALANCE {
        varchar staff_id_员工ID
        int total_points_当前总积分
        datetime update_time_更新时间
    }
    STAFF_POINTS_DEDUP {
        varchar dedup_key_幂等键
        varchar staff_id_员工ID
        varchar event_code_事件编码
        varchar source_type_来源类型
        varchar source_id_来源ID
        datetime create_time_创建时间
    }

    SYS_USER ||--o{ STAFF_POINTS_LOG : 产生
    SYS_USER ||--o{ STAFF_POINTS_BALANCE : 汇总
    STAFF_POINTS_RULE ||--o{ STAFF_POINTS_LOG : 约束
    STAFF_POINTS_DEDUP ||--o{ STAFF_POINTS_LOG : 防重
```

六、开发工作台（DevWorkbench）概览接口（新增）
1) 设计目标
- 为工作台首页提供概览数据：最新动态、项目列表、当前用户待办事项数量与列表、我的项目数量、我的团队成员数量等。

2) 接口前缀
- 统一前缀：/jeecgboot/dashboard/devworkbench
- 说明：前端 /src/views/dashboard/devworkbench/devworkbench.api.ts 使用不含 "/jeecgboot" 的相对路径，实际通过 Axios 的 urlPrefix 自动拼接 "/jeecgboot"，与本文档保持一致。

3) 接口列表与字段
- GET /dynamic/list
  - 描述：获取最新动态列表
  - 参数：pageSize（可选，默认 10）
  - 返回：DynamicInfoItem[]（数组，非分页）
    - 字段：
      - id：number|string（动态ID）
      - avatar：string（头像/图标标识）
      - name：string（人员名称）
      - date：string（发生时间描述，如“刚刚/1小时前”）
      - desc：string（富文本描述，可包含 <a> 链接）
  - 示例响应：
    {
      "success": true,
      "code": 200,
      "result": [
        { "id": 1, "avatar": "dynamic-avatar-1|svg", "name": "威廉", "date": "刚刚", "desc": "在 <a>开源组</a> 创建了项目 <a>Vue</a>" },
        { "id": 2, "avatar": "dynamic-avatar-2|svg", "name": "艾文", "date": "1个小时前", "desc": "关注了 <a>威廉</a>" }
      ],
      "timestamp": 1710000000000
    }

- GET /project/list
  - 描述：获取项目卡片列表（概览）
  - 参数：pageSize（可选，默认 6）
  - 返回：GroupItem[]（数组，非分页）
    - 字段：
      - id：number|string（项目ID）
      - title：string（项目名称）
      - icon：string（图标标识）
      - color：string（主题色）
      - desc：string（项目一句话简介）
      - group：string（所属分组/团队）
      - date：string（日期）
  - 示例响应：
    {
      "success": true,
      "code": 200,
      "result": [
        { "id": 1, "title": "Github", "icon": "carbon:logo-github", "color": "", "desc": "不要等待机会，而要创造机会。", "group": "开源组", "date": "2024-01-01" },
        { "id": 2, "title": "Vue", "icon": "ion:logo-vue", "color": "#3fb27f", "desc": "现在的你决定将来的你。", "group": "算法组", "date": "2024-01-03" }
      ],
      "timestamp": 1710000000000
    }

- GET /todo/list（新增）
  - 描述：获取当前用户的待办事项列表
  - 参数：
    - pageSize（可选，默认 10，返回前 N 条）
    - status（可选，枚举：TODO/IN_PROGRESS/DONE）
  - 返回：TodoItem[]（数组，非分页）
    - 字段：
      - id：string（待办ID）
      - title：string（待办标题）
      - status：string（状态：TODO/IN_PROGRESS/DONE）
      - priority：string（优先级：LOW/MEDIUM/HIGH）
      - dueDate：string（到期日期，yyyy-MM-dd）
      - projectName：string（关联项目名称，可选）
  - 示例响应：
    {
      "success": true,
      "code": 200,
      "result": [
        { "id": "todo-1", "title": "修复登录页面Bug", "status": "TODO", "priority": "HIGH", "dueDate": "2024-11-10", "projectName": "Verto平台" },
        { "id": "todo-2", "title": "补充项目文档", "status": "IN_PROGRESS", "priority": "MEDIUM", "dueDate": "2024-11-12", "projectName": "用户中心" }
      ],
      "timestamp": 1710000000000
    }

- GET /overview（新增）
  - 描述：工作台概览统计（当前用户维度）
  - 参数：无
  - 返回：OverviewStats（对象）
    - 字段：
      - todoCount：number（我的待办数量）
      - myProjectCount：number（我参与的项目数量）
      - myTeamMemberCount：number（我所在项目的团队成员总数，去重）
  - 示例响应：
    {
      "success": true,
      "code": 200,
      "result": { "todoCount": 7, "myProjectCount": 3, "myTeamMemberCount": 18 },
      "timestamp": 1710000000000
    }

4) 权限
- dashboard:view（或更细粒度的 devworkbench:view）即可访问上述只读接口。

5) 说明与实现建议
- 数据来源：
  - 待办（/todo/list）：可对接项目任务模块或统一待办中心，按当前用户过滤；短期可使用 Mock 数据。
 - 概览统计（/overview）：
    - todoCount：统计当前用户待办数量（当前库未建待办表，建议后续增加；暂以业务计算为准）
    - myProjectCount：按 project 表统计当前用户作为开发者（developer_id = 当前用户ID）参与的项目数量
    - myTeamMemberCount：按 project 表在同一应用或同一团队下，统计参与项目的开发者（developer_id）去重数量；后续如增加项目成员表再切换为更精确计算
- 返回结构：统一 JeecgBoot Result<T>；如需分页再返回 records/total 结构。
- 与前端对齐：
  - 前端 API 枚举：/src/views/dashboard/devworkbench/devworkbench.api.ts L6-L8 已定义 /dynamic/list 与 /project/list；本文档新增 /todo/list 与 /overview 以支撑“待办”和“概览统计”。

示例统计 SQL（基于现有表）：
- 我的项目数量（developer 维度）：
```
SELECT COUNT(*) AS myProjectCount
FROM project
WHERE developer_id = :currentUserId;
```
- 我的团队成员数量（同应用下开发者去重，近似方案）：
```
SELECT COUNT(DISTINCT p2.developer_id) AS myTeamMemberCount
FROM project p1
JOIN project p2 ON p2.related_app_id = p1.related_app_id
WHERE p1.developer_id = :currentUserId
  AND p2.developer_id IS NOT NULL;
```
说明：如后续新增项目成员表（如 project_member），统计可改为基于成员关联的更精确口径。

—

七、示例请求与响应（片段）
1) GET /jeecgboot/staff/points/summary?staffId=1
返回：
{
  "success": true,
  "code": 200,
  "result": { "totalPoints": 5 },
  "timestamp": 1710000000000
}

2) GET /jeecgboot/staff/points/logs?staffId=1&pageNo=1&pageSize=10&eventType=MANUAL_ADJUST
返回：
{
  "success": true,
  "code": 200,
  "result": {
    "records": [
      {
        "id": "log-1-001",
        "staffId": "1",
        "delta": 1,
        "eventType": "MANUAL_ADJUST",
        "sourceType": "APP",
        "sourceId": "app-uc",
        "sourceName": "用户中心",
        "remark": "作为应用维护默认+1",
        "createTime": "2024-02-01 09:00:00"
      }
    ],
    "total": 5
  }
}

3) POST /jeecgboot/staff/points/adjust
请求体：
{
  "staffId": "1",
  "delta": -2,
  "remark": "项目扣分",
  "sourceType": "PROJECT",
  "eventType": "MANUAL_ADJUST",
  "sourceId": "prj-xyz",
  "sourceName": "项目XYZ"
}
返回：
{
  "success": true,
  "code": 200,
  "result": { "success": true },
  "timestamp": 1710000000000
}

—

八、验收清单（新增）
- 库表 staff_points_log 已建且索引生效；能插入与查询。
- 接口 /summary、/logs、/logs/all、/adjust 均可用；权限控制生效。
- 分页与筛选逻辑正确；时间区间、关键字匹配符合预期。
- 总分与流水一致性：调整后总分即时变化。
- 返回结构与前端适配一致（records/total）。

如需，我可以进一步提供：
- 完整的 Mapper XML/Service/Controller 代码样例（基于 MyBatis-Plus 与 JeecgBoot Result）。
- 一份初始化示例数据脚本，便于快速联调。